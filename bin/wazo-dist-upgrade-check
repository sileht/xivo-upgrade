#!/usr/bin/env python3
# Copyright 2018 The Wazo Authors  (see the AUTHORS file)
# SPDX-License-Identifier: GPL-3.0+

import argparse
import os
import platform
import requests
import sys
import urllib3
from distutils.version import LooseVersion

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


class WazoDistUpgradeException(Exception):
    pass


class WizardNotConfigured(WazoDistUpgradeException):

    _message = 'The Wazo wizard is not configured.'

    def __init__(self):
        super().__init__(self._message)


class ConfdError(WazoDistUpgradeException):

    _message = 'xivo-confd is not reachable. You should check /var/log/xivo-confd.log for errors.'

    def __init__(self):
        super().__init__(self._message)


class WrongWazoVersion(WazoDistUpgradeException):

    _message = 'wazo-dist-upgrade should not be run on Wazo {version}. You should run wazo-upgrade instead.'

    def __init__(self, wazo_version):
        super().__init__(self._message.format(version=wazo_version))


class KernelLibException(WazoDistUpgradeException):

    _message = 'Unable to found kernel in /lib/modules. Please install linux-image-amd64 or linux-image-686'

    def __init__(self):
        super().__init__(self._message.format())


class WrongKernelVersion(WazoDistUpgradeException):

    _message = """wazo-dist-upgrade should not be run on system without the last kernel available.
You must reboot before re-run wazo-dist-upgrade.
The last kernel installed is: {last_version} and the running kernel is {running_version}"""

    def __init__(self, last_version, running_version):
        super().__init__(self._message.format(last_version=last_version, running_version=running_version))



class UpgradeAborted(WazoDistUpgradeException):

    _message = 'Aborting.'

    def __init__(self):
        super().__init__(self._message)


def main():
    args = parse_args()
    try:
        check_wazo_version()
        check_wizard_is_run()
        check_last_kernel_booted()
        if not args.force:
            confirm_upgrade()
    except WazoDistUpgradeException as e:
        print(e, file=sys.stderr)
        sys.exit(1)


def parse_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('-f',
                        '--force',
                        action='store_true',
                        help="Disable interactive prompts. Default: %(default)s")
    return parser.parse_args()


def check_last_kernel_booted():
    installed_kernels = sorted([LooseVersion(version) for version in os.listdir('/lib/modules')])
    running_kernel = platform.release()
    try:
        last_available_kernel = str(installed_kernels.pop())
    except IndexError:
        raise KernelLibException()

    if running_kernel != last_available_kernel:
        raise WrongKernelVersion(last_available_kernel, running_kernel)


def check_wazo_version():
    # 17.17 = latest prod version, 18.01 = latest dev version
    if installed_wazo_version() not in ('17.17', '18.01'):
        raise WrongWazoVersion(installed_wazo_version())


def installed_wazo_version():
    with open('/usr/share/xivo/XIVO-VERSION', 'r') as version_file:
        return str(version_file.read()).strip()


def check_wizard_is_run():
    port = os.environ.get('XIVO_CONFD_PORT', '9486')
    try:
        r = requests.get('https://localhost:{port}/1.1/wizard'.format(port=port), verify=False)
    except requests.RequestException:
        raise ConfdError()

    try:
        if r.json()['configured'] is False:
            raise WizardNotConfigured()
    except (ValueError, KeyError):
        raise ConfdError()


def confirm_upgrade():
    while True:
        answer = input('Would you like to upgrade your system (all services will be restarted) [y/n]? ').lower()
        if answer not in ('y', 'n'):
            print('Invalid answer.')
            continue
        else:
            break

    if answer == 'n':
        raise UpgradeAborted()


if __name__ == '__main__':
    main()
